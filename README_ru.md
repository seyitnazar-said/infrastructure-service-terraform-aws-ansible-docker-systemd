# –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –°–µ—Ä–≤–∏—Å

## –û–±–∑–æ—Ä
–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å–µ—Ä–≤–∏—Å –≤ AWS —Å –ø–æ–º–æ—â—å—é **Terraform**, **Ansible**, **Docker** –∏ **Go**.

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–∞ –≤–∞—à–µ–π **—É–ø—Ä–∞–≤–ª—è—é—â–µ–π –º–∞—à–∏–Ω–µ** (VM) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

* [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)
* [Terraform](https://developer.hashicorp.com/terraform/downloads)
* [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/)

–¢–∞–∫–∂–µ –Ω—É–∂–µ–Ω –∞–∫–∫–∞—É–Ω—Ç AWS —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ (`aws configure`).

## üèóÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### Terraform 
–ü–∞–ø–∫–∞ `infra/terraform`.
C–æ–∑–¥–∞—ë—Ç –≤ AWS:

- **VPC** —Å –ø–æ–¥—Å–µ—Ç—å—é - `10.0.0.0/16`
- **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—à–ª—é–∑**
- **2 –ø—É–±–ª–∏—á–Ω—ã–µ –ø–æ–¥—Å–µ—Ç–∏** - `10.0.1.0/24` –∏ `10.0.2.0/24`
- **–¢–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–æ–≤** —Å –≤—ã—Ö–æ–¥–æ–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
- **–ü—Ä–∏–≤—è–∑–∫—É –ø–æ–¥—Å–µ—Ç–µ–π** –∫ —Ç–∞–±–ª–∏—Ü–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
- **–ü–∞—Ä—É SSH-–∫–ª—é—á–µ–π** - (RSA 4096)
- **Security Group** -  —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏ `22`, `80`, `8080` –∏ `443`
- **EC2-–∏–Ω—Å—Ç–∞–Ω—Å Ubuntu 22.04** - t3.micro, —Å –ø—É–±–ª–∏—á–Ω—ã–º IP
- **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ (ALB)** —Å —Ü–µ–ª–µ–≤—ã–º–∏ –≥—Ä—É–ø–ø–∞–º–∏ –Ω–∞ –ø–æ—Ä—Ç—ã `80` –∏ `8080`
- **–ù–∞—Å—Ç—Ä–æ–π–∫—É —Å–ª—É—à–∞—Ç–µ–ª–µ–π** –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç–∞–Ω—Å–∞ –≤ **—Ü–µ–ª–µ–≤—ã—Ö –≥—Ä—É–ø–ø–∞—Ö**

**–í—ã–≤–æ–¥—ã Terraform**

* `lb_dns_name` ‚Äì DNS-–∏–º—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞
* `ubuntu_instance_public_ip` ‚Äì –ø—É–±–ª–∏—á–Ω—ã–π IP –∏–Ω—Å—Ç–∞–Ω—Å–∞

<br>

### Ansible (–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å)

–ü–∞–ø–∫–∞ `infra/ansible`. 
–ü–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã Terraform —ç—Ç–æ—Ç –ø–ª–µ–π–±—É–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç:
- **docker-ce**
- **docker-ce-cli**
- **containerd.io**
- **docker-buildx-plugin** 
- **docker-compose-plugin**

<br>

## üöÄ –°–µ—Ä–≤–∏—Å

### Ansible (—É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä–≤–∏—Å–∞)
–ü–∞–ø–∫–∞ `service/ansible`.
–≠—Ç–æ—Ç –ø–ª–µ–π–±—É–∫ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ EC2-–∏–Ω—Å—Ç–∞–Ω—Å–µ, –≤—ã–ø–æ–ª–Ω—è—è —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

- –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–æ–ª—å **`docker-service`**.
- –°–æ–∑–¥–∞—ë—Ç —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
- –ö–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã **(`Dockerfile`, `docker-compose.yaml`, `Go-–∫–æ–¥`, –∏ unit-—Ñ–∞–π–ª systemd `skillbox.service`)**
- –°–æ–±–∏—Ä–∞–µ—Ç **Docker-–æ–±—Ä–∞–∑** –∏–∑ **Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ –≤–∫–ª—é—á–∞–µ—Ç **`systemd-—Å–µ—Ä–≤–∏—Å`**, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ.

## üêπ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

- **Test** ‚Äì –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–º Go-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
- **Build** ‚Äì –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã–π `Dockerfile` —Å–æ–±–∏—Ä–∞–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –æ–±—Ä–∞–∑.
- **Compose** ‚Äì `docker-compose` —Å—Ç—Ä–æ–∏—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
- **Service** ‚Äì `systemd` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏ —Å–ª–µ–¥–∏—Ç –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º.

<br>

## üß≠ –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å

–ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ:

**–£–ø—Ä–∞–≤–ª—è—é—â–∞—è VM ‚Üí AWS –∞–∫–∫–∞—É–Ω—Ç ‚Üí EC2-–∏–Ω—Å—Ç–∞–Ω—Å**

1. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ AWS**
- –°–æ–∑–¥–∞–π—Ç–µ IAM-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π **AdministratorAccess** (–∏–ª–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—É–∂–Ω—ã).
- –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ **Access Key ID** –∏ **Secret Access Key**.
- –ù–∞ —É–ø—Ä–∞–≤–ª—è—é—â–µ–π VM –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
aws configure
```
–í–≤–µ–¥–∏—Ç–µ Access Key, Secret Key, —Ä–µ–≥–∏–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, `us-east-1`) –∏ —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞.

> ‚ö†Ô∏è **–°–æ–≤–µ—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** 
> –•—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏ –≤ –Ω–∞–¥—ë–∂–Ω–æ–º –º–µ—Å—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `~/.aws/credentials`) –∏ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –∏—Ö –≤ GitHub**.

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã Terraform**
```bash
cd infra/terraform
```

```bash
terraform init
```

```bash
terraform plan
```

```bash
terraform apply -auto-approve
```

**–≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç VPC, –ø–æ–¥—Å–µ—Ç–∏, EC2 –∏–Ω—Å—Ç–∞–Ω—Å, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ (ALB), –≥—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –¥—Ä—É–≥–∏–µ —Ä–µ—Å—É—Ä—Å—ã.**

<br>

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `apply` –∏—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∫–ª—é—á –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∏–Ω—Å—Ç–∞–Ω—Å—É –ø–æ SSH:**

```bash
sudo chmod 600 .ssh/terraform_rsa
```

```bash
ssh -i .ssh/terraform_rsa ubuntu@<public_ip>
```

<br>

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö–æ—Å—Ç–∞ Ansible (Docker & Docker Compose)**

```bash
cd infra/ansible
```

```bash
ansible-playbook -i docker.inv docker.yml -b -vvv --ask-become-pass
```

<br>

**–î–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å–∞ —Å –ø–æ–º–æ—â—å—é Ansible** 

```bash
cd service
```

```bash
ansible-playbook -i host.inv playbook.yml -b -vvv --ask-become-pass
```

**–≠—Ç–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –≤–∞—à—É —É–ø—Ä–∞–≤–ª—è—é—â—É—é –º–∞—à–∏–Ω—É –∫ AWS —Å –≤–∞—à–∏–º IAM-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –∫–ª—é—á–∞–º–∏.
- –° –ø–æ–º–æ—â—å—é Terraform —Å–æ–∑–¥–∞—ë—Ç –≤—Å—é –Ω—É–∂–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ó–∞–ø—É—Å–∫–∞–µ—Ç Ansible –¥–≤–∞ —Ä–∞–∑–∞:
  **—Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Docker –∏ Docker Compose**
  **–ø–æ—Ç–æ–º —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–∫–ª—é—á–∞–µ—Ç –µ–≥–æ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd**

### üåê –î–æ—Å—Ç—É–ø –ø–æ —Å–≤–æ–µ–º—É –¥–æ–º–µ–Ω—É (DreamHost)

–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –≤ AWS –∏ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ (ALB) –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å —Å–≤–æ–π –¥–æ–º–µ–Ω –∫ ALB —á–µ—Ä–µ–∑ **CNAME-–∑–∞–ø–∏—Å—å** —É –≤–∞—à–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ DNS (–Ω–∞–ø—Ä–∏–º–µ—Ä, DreamHost).

**–®–∞–≥–∏:**

1. –í–æ–π–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å DNS –≤–∞—à–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DreamHost).
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é **CNAME-–∑–∞–ø–∏—Å—å**, —É–∫–∞–∑—ã–≤–∞—é—â—É—é –≤–∞—à –ø–æ–¥–¥–æ–º–µ–Ω –Ω–∞ **DNS-–∏–º—è ALB**, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–¥–∞–ª Terraform (`lb_dns_name`).
   - **–ü—Ä–∏–º–µ—Ä:**
     ```
     subdomain.example.com ‚Üí my-alb-123456.us-east-1.elb.amazonaws.com
     ```
3. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DNS (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç –¥–æ –ø–∞—Ä—ã —á–∞—Å–æ–≤).
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø:
   ```bash
   curl http://subdomain.example.com:8080

üßπ –û—á–∏—Å—Ç–∫–∞

**–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã AWS:**

```bash
cd infra/terraform
```

```bash
terraform destroy
```